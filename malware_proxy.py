# Stage 1 of a malware filtering proxy.
# Written for CS 4480 Computer Networks with Prof. Kobus Van der Merwe
# Last edit: January 28th, 2016
# Author: Jake Pitkin
# Repository: https://github.com/jspitkin/malware_proxy_1.git

import socket
import select
import sys
from urlparse import urlparse

def main():
    serverPort = int(sys.argv[1])
    serverAddress = 'localhost'

    serverSocket = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    print 'Got a socket:', serverSocket.fileno()

    serverSocket.bind((serverAddress,serverPort))
    print 'Bound to:', serverSocket.getsockname()

    serverSocket.listen(1)

    input = [serverSocket]

    while 1:

        inputready,outputready,exceptready = select.select(input,[],[])

        for s in inputready:

            if s == serverSocket:
                print 'Handle server socket'
                connectionSocket, addr = serverSocket.accept()
                print 'Accepted connection from:', connectionSocket.getpeername()
                input.append(connectionSocket)

            else :
                host = ''
                path = ''
                response400 = 0
                response501 = 0
                    
                while 1:
                    requestLine = s.recv(1024)
                    if requestLine == '\r\n':
                        break
                    if badMethod(requestLine):
                        response501 = 1
                    parsedRequest = parseRequest(requestLine)
                    if parsedRequest[0]:
                        response400 = 1
                    if len(parsedRequest) == 3:
                        host = parsedRequest[1]
                        path = parsedRequest[2]
                    if len(parsedRequest) == 2:
                        host = parsedRequest[1]
                if response400 and response501 != 1:
                    s.send('HTTP/1.1 400 Bad request\n')
                elif response501:
                    s.send('HTTP/1.1 501 Not Implemented\n')
                elif host != '' and path != '':
                    requestContent = requestPage(path, host)
                    s.send(requestContent) 
                s.close()
                input.remove(s)

# Return:
#   1 - Method was a non-GET method
#   0 - otherwise
def badMethod(request):
    separatedRequest = request.split()
    method = separatedRequest[0]
    if method == 'HEAD' or method == 'POST' or method == 'PUT' or \
       method == 'OPTIONS' or method == 'DELETE' or method == 'TRACE' or \
       method == 'CONNECT': 
        return 1
    return 0

# Return:
#   [0] - 1 if the request is invalid, 0 otherwise
#   [1] - hostname
#   [2] - path
def parseRequest(request):
    separatedRequest = request.split()
    if separatedRequest[0] == 'Host:':
        return 0, separatedRequest[1]
    if separatedRequest[0] == 'GET':
        parsedURL = urlparse(separatedRequest[1])
        if parsedURL.hostname is not None and parsedURL.path is not None:
            return 0, parsedURL.hostname, parsedURL.path 
    return 1, ''

# Makes a request to the remote server
# Return:
#   The response from the remote server
def requestPage(path, host):
    request = 'GET ' + path + ' HTTP/1.0\n'
    request += 'Host: ' + host + '\n'
    request += 'Connection: close\n\n'
    remoteSocket = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    remoteSocket.connect((host,80))
    remoteSocket.send(request)
    content = remoteSocket.recv(16384)
    return content

if __name__ == "__main__":
    main()